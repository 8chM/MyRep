blueprint:
  name: Thermostatsteuerung mit Anwesenheitserkennung
  description: Automatische Steuerung des Thermostats auf Basis der Anwesenheit von Personen

  input:
    thermostat_entity:
      name: Thermostat
      description: Das Thermostat, das gesteuert werden soll
      selector:
        entity:
          domain: climate
    presence_entity:
      name: Präsenz-Tracker
      description: Der Tracker für Anwesenheitserkennung
      selector:
        entity:
          domain: device_tracker
    anwesenheit_1:
      name: Anwesenheit 1
      description: Zeit und Temperatur für Anwesenheit 1
      selector:
        entity:
          domain: input_datetime
    anwesenheit_2:
      name: Anwesenheit 2
      description: Zeit und Temperatur für Anwesenheit 2
      selector:
        entity:
          domain: input_datetime
    anwesenheit_3:
      name: Anwesenheit 3
      description: Zeit und Temperatur für Anwesenheit 3
      selector:
        entity:
          domain: input_datetime

  trigger:
    platform: state
    entity_id: !input 'presence_entity'
  condition:
    condition: state
    entity_id: !input 'presence_entity'
    state: 'home'
  action:
    - choose:
        - conditions:
            - condition: time
              after: !input 'anwesenheit_1'
              before: !input 'anwesenheit_2'
          sequence:
            - service: climate.set_temperature
              target:
                entity_id: !input 'thermostat_entity'
              data:
                temperature: '{{ states("input_number.thermostat_temperature_anwesenheit") }}'
        - conditions:
            - condition: time
              after: !input 'anwesenheit_2'
              before: !input 'anwesenheit_3'
          sequence:
            - service: climate.set_temperature
              target:
                entity_id: !input 'thermostat_entity'
              data:
                temperature: '{{ states("input_number.thermostat_temperature_anwesenheit") }}'
        - conditions:
            - condition: time
              after: !input 'anwesenheit_3'
          sequence:
            - service: climate.set_temperature
              target:
                entity_id: !input 'thermostat_entity'
              data:
                temperature: '{{ states("input_number.thermostat_temperature_anwesenheit") }}'
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: !input 'presence_entity'
                  state: 'home'
          sequence:
            - service: climate.set_temperature
              target:
                entity_id: !input 'thermostat_entity'
              data:
                temperature: '{{ states("input_number.thermostat_temperature_abwesenheit") }}'
